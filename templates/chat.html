<!-- chat.html with delete/mute/unmute and (muted) labels -->
<!DOCTYPE html>
<html>
<head>
  <title>Chatroom</title>
  <style>
    .chat-message {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .admin-controls {
      margin-left: 10px;
    }
    .muted-label {
      color: red;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>Welcome, {{ username }}{% if is_mod %} [MOD]{% endif %}</h1>
  <div id="chatbox">
    {% for message in messages %}
      <div class="chat-message" data-id="{{ message.id }}">
        <span>
          {{ message.timestamp.strftime('%H:%M') }} - {{ message.username }}
          {% if message.username in muted %}<span class="muted-label">(muted)</span>{% endif %}: {{ message.text|safe }}
        </span>
        {% if is_mod %}
          <span class="admin-controls">
            <button onclick="deleteMessage({{ message.id }})">🗑️</button>
            {% if message.username in muted %}
              <button onclick="unmuteUser('{{ message.username }}')">🔊</button>
            {% else %}
              <button onclick="muteUser('{{ message.username }}')">🔇</button>
            {% endif %}
          </span>
        {% endif %}
      </div>
    {% endfor %}
  </div>
  <form id="chat-form">
    <input type="text" id="message" placeholder="Type a message..." required autocomplete="off">
    <button type="submit">Send</button>
  </form>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io();
    const chatbox = document.getElementById('chatbox');
    const form = document.getElementById('chat-form');
    const messageInput = document.getElementById('message');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const msg = messageInput.value.trim();
      if (msg) {
        socket.emit('chat', msg);
        messageInput.value = '';
      }
    });

    socket.on('chat', (data) => {
      const div = document.createElement('div');
      div.className = 'chat-message';
      div.dataset.id = data.id;
      div.innerHTML = `<span>${data.timestamp} - ${data.username}: ${data.text}</span>`;
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight;
    });

    socket.on('remove_message', (msgId) => {
      const msgEl = document.querySelector(`.chat-message[data-id='${msgId}']`);
      if (msgEl) msgEl.remove();
    });

    function deleteMessage(id) {
      socket.emit('delete_message', id);
    }

    function muteUser(username) {
      socket.emit('mute_user', username);
    }

    function unmuteUser(username) {
      socket.emit('unmute_user', username);
    }
  </script>
</body>
</html>
