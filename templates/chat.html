<!DOCTYPE html>
<html>
<head>
  <title>Chatroom</title>
</head>
<body>
  <h1>Welcome, {{ username }}!</h1>
  <div style="display: flex; gap: 20px;">
    <!-- Online Users -->
    <div style="width: 200px; border: 1px solid black; padding: 10px;">
      <h3>Online Users</h3>
      <ul id="users">
        <!-- Will be filled dynamically -->
      </ul>
    </div>

    <!-- Chat Section -->
    <div style="flex-grow: 1; border: 1px solid black; padding: 10px;">
      <h3>Chat</h3>
      <div id="chatbox" style="height: 200px; overflow-y: scroll; border: 1px solid gray; padding: 5px;">
        {% for message in messages %}
          <div>{{ message.timestamp.strftime('%H:%M') }} - {{ message.username }}: {{ message.text }}</div>
        {% endfor %}
      </div>

      <form id="chat-form">
        <input type="text" id="message" placeholder="Type message..." required autocomplete="off">
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <p><a href="/logout">Logout</a></p>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io();
    const form = document.getElementById('chat-form');
    const messageInput = document.getElementById('message');
    const chatbox = document.getElementById('chatbox');
    const userList = document.getElementById('users');

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const msg = messageInput.value.trim();
      if (msg.length > 0) {
        socket.emit('chat', msg);
        messageInput.value = '';
      }
    });

    socket.on('chat', (data) => {
      const div = document.createElement('div');
      div.textContent = `${data.timestamp} - ${data.username}: ${data.text}`;
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight; // Auto-scroll
    });

    socket.on('update_users', (usernames) => {
      userList.innerHTML = '';
      usernames.forEach(user => {
        const li = document.createElement('li');
        li.textContent = user;
        userList.appendChild(li);
      });
    });
  </script>
</body>
</html>
