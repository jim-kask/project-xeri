{% extends 'base.html' %}

{% block title %}Stress â€” Tables{% endblock %}


{% block content %}
<style>
  /* Adaptive cards (light/dark) */
  .tables-card { border-radius:14px; padding:14px; border:1px solid; }
  body.dark-mode .tables-card { background:#111827; color:#e5e7eb; border-color:#2b2f36; }
  body:not(.dark-mode) .tables-card { background:#f3f4f6; color:#111827; border-color:#d1d5db; }
  .tables-card .meta { font-size:14px; margin-top:2px; }
  body.dark-mode .tables-card .meta { color:#cbd5e1; }
  body:not(.dark-mode) .tables-card .meta { color:#374151; }

  /* Left panel layout + bottom-left Back button */
  .tables-aside { position:relative; padding-bottom:72px; }
  .back-btn {
    position:absolute; left:16px; bottom:16px;
    display:inline-flex; align-items:center; gap:6px;
    padding:8px 12px; border-radius:8px; text-decoration:none; font-size:14px;
    border:1px solid; box-shadow:0 1px 2px rgba(0,0,0,.08);
  }
  body.dark-mode .back-btn { background:#0b1220; color:#e5e7eb; border-color:#2b2f36; }
  body:not(.dark-mode) .back-btn { background:#eef2f7; color:#111827; border-color:#cbd5e1; }

  /* Left panel text contrast */
  .tables-title { margin-top:16px; }
  .tables-subtitle { margin:6px 0 14px 0; font-size:14px; }

/* Left panel dark-mode background so text remains readable */
body.dark-mode .game-panel {
  background:#0b1220;          /* match the right panel vibe */
  color:#e5e7eb;
  border-color:#2b2f36;        /* if your panel has a border */
}

/* (Optional) ensure headings keep good contrast */
body.dark-mode .game-panel .tables-title   { color:#e5e7eb; }
body.dark-mode .game-panel .tables-subtitle{ color:#cbd5e1; }

  body.dark-mode .tables-title { color:#e5e7eb; }
  body.dark-mode .tables-subtitle { color:#cbd5e1; }
  body:not(.dark-mode) .tables-title { color:#111827; }
  body:not(.dark-mode) .tables-subtitle { color:#374151; }
</style>

<div class="main-grid">
  <!-- LEFT PANEL -->
  <aside class="game-panel tables-aside">
    <h2 class="tables-title">Stress â€” Tables</h2>
    <p class="tables-subtitle">Welcome, {{ username }}! Choose an action below.</p>

    <!-- Action buttons -->
    <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px;">
      <button onclick="createTable()" 
              style="padding:10px;border-radius:10px;border:none;background:#2563eb;color:white;cursor:pointer;">
        âž• Create Table
      </button>

      <button onclick="joinRandomTable()" 
              style="padding:10px;border-radius:10px;border:none;background:#10b981;color:white;cursor:pointer;">
        ðŸŽ² Join Random Table
      </button>
    </div>

    <!-- The ONLY back button (bottom-left inside the panel) -->
    <a href="{{ url_for('chat') }}" class="back-btn">â¬… Back</a>
  </aside>

  <!-- RIGHT PANEL -->
  <section class="chat-panel" style="padding:16px;">
    <h3 style="margin-bottom:14px;">Available Tables</h3>
<button id="createTableBtn">Create Table</button>

    <div id="tables-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;">
      {% for t in tables %}
      <div class="tables-card">
        <div style="font-weight:600;margin-bottom:6px;">{{ t.name }}</div>
        <div class="meta">Players: {{ t.players }}</div>
        <div class="meta">Status: {{ t.status }}</div>
        <div style="margin-top:10px;">
          <a href="{{ url_for('game_room', room_name=room) }}?table={{ t.id }}" 
             class="game-tile" 
             style="padding:6px 10px;border-radius:10px;text-decoration:none;">
             Join
          </a>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>
</div>

<script>
async function createTable() {
  try {
    const res = await fetch("{{ url_for('stress.api_create') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: "" })
    });
    const data = await res.json();
    if (data && data.url) {
      window.location.href = data.url; // -> /game/stress/<room>
    } else {
      alert(data?.error || "Could not create table.");
    }
  } catch {
    alert("Network error while creating table.");
  }
}

async function joinRandomTable() {
  try {
    const res = await fetch("{{ url_for('stress.api_create') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ join_random: true })
    });
    const data = await res.json();
    if (data && data.url) {
      window.location.href = data.url;
    } else {
      alert(data?.error || "No open tables available.");
    }
  } catch {
    alert("Network error while joining a table.");
  }
}


</script>

<script>
(async function(){
  const listEl = document.getElementById('tables-list') || (function(){
    const el = document.createElement('div');
    el.id = 'tables-list';
    document.body.appendChild(el);
    return el;
  })();

  async function refresh() {
    const res = await fetch('/game/stress/api/list');
    const data = await res.json();
    listEl.innerHTML = '';
    (data.rooms || []).forEach(r => {
      const a = document.createElement('a');
      a.href = `/game/stress/${r.id}`;
      a.textContent = r.locked ? `ðŸ”’ ${r.id}` : r.id;
      a.style.display = 'block';
      a.style.margin = '6px 0';
      listEl.appendChild(a);
    });
  }

  // Create Table button by id (add the button in your markup if missing)
  const createBtn = document.getElementById('createTableBtn');
  if (createBtn) {
    createBtn.addEventListener('click', async () => {
      const name = prompt('Optional table name:') || '';
      const password = prompt('Password? Leave empty for public:') || '';
      const res = await fetch('/game/stress/api/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, password })
      });
      const data = await res.json();
      if (data.url) window.location.href = data.url;
    });
  }

  await refresh();
})();
</script>

{% endblock %}
